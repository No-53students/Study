name: Auto Build and Deploy

on:
  push:
    branches: [ main ]  # æˆ– masterï¼Œå–å†³äºæ‚¨çš„ä¸»åˆ†æ”¯åç§°

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # 1. æ£€å‡ºä»£ç 
    - uses: actions/checkout@v3

    # 2. è®¾ç½®Dockerç¯å¢ƒ
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 3. ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“ï¼ˆæ¨èä½¿ç”¨å®˜æ–¹Actionï¼‰
    - name: Login to Aliyun Registry
      uses: docker/login-action@v2
      with:
        registry: crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}  # å»ºè®®ä½¿ç”¨Secretè€Œéç¡¬ç¼–ç 
        password: ${{ secrets.ALIYUN_PASSWORD }}

    # 4. è·å–Gitä¿¡æ¯ç”¨äºé•œåƒæ ‡ç­¾
    - name: Get Git Info
      id: git
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT

    # 5. æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆä½¿ç”¨docker/build-push-actionæ›´ç¨³å®šï¼‰
    - name: Build and Push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com/53_student_study_1/study_1:latest
          crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com/53_student_study_1/study_1:${{ steps.git.outputs.sha_short }}
          crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com/53_student_study_1/study_1:${{ steps.git.outputs.branch }}

    # 6. éƒ¨ç½²åˆ°ECSæœåŠ¡å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰
    - name: Deploy to ECS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.ECS_HOST }}  # å»ºè®®ä½¿ç”¨Secretè€Œéç¡¬ç¼–ç 
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          #!/bin/bash
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åº”ç”¨..."

          # ç™»å½•é•œåƒä»“åº“
          echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
          docker login --username=${{ secrets.ALIYUN_USERNAME }} --password=${{ secrets.ALIYUN_PASSWORD }} crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com

          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker pull crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com/53_student_study_1/study_1:latest

          # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
          echo "â¹ï¸ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
          docker stop study-app || true
          docker rm study-app || true

          # è¿è¡Œæ–°å®¹å™¨ï¼ˆæ·»åŠ é‡å¯ç­–ç•¥å’Œæ ‡ç­¾ï¼‰
          echo "ğŸƒ è¿è¡Œæ–°å®¹å™¨..."
          docker run -d \
            --name study-app \
            --restart=always \
            --label "git.commit=${{ steps.git.outputs.sha_short }}" \
            --label "deploy.time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -p 3000:3000 \
            crpi-86g0zmv6zs7w8xtg.cn-hangzhou.personal.cr.aliyuncs.com/53_student_study_1/study_1:latest

          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆ15ç§’ï¼‰..."
          sleep 15

          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if docker ps | grep -q study-app; then
            echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"

            # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
            echo "ğŸ“‹ å®¹å™¨ä¿¡æ¯:"
            docker ps | grep study-app

            # æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—
            echo "ğŸ“ æœ€è¿‘20è¡Œæ—¥å¿—:"
            docker logs study-app | tail -20
          else
            echo "âŒ å®¹å™¨æœªè¿è¡Œï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—:"
            docker logs study-app || true
            exit 1
          fi

          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f

          echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"

    # 7. éƒ¨ç½²æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    - name: Notify on Success
      if: success()
      run: echo "âœ… éƒ¨ç½²æˆåŠŸï¼åº”ç”¨å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ (${{ steps.git.outputs.sha_short }})"
